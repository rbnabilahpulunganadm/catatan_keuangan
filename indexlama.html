<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Administrasi v2.2 - Nabilah Pulungan Clinic</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons (browser version) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Libraries for Exporting Data -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* View transition styles */
        .view {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        .view.active {
            display: block;
        }

        /* Animation keyframes */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-card {
            animation: popIn 0.5s ease-out forwards;
            opacity: 0;
            transform: scale(0.95);
        }
        @keyframes popIn {
            to { opacity: 1; transform: scale(1); }
        }
        
        /* Required field indicator */
        .required-label::after {
            content: ' *';
            color: #ef4444; /* red-500 */
        }

        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3b82f6; /* Blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 40px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Sidebar Navigation -->
    <aside class="w-64 bg-white border-r border-slate-200 flex flex-col transition-all duration-300">
        <div class="p-6 border-b border-slate-200">
            <h1 class="text-xl font-bold text-slate-800">Klinik & Spa</h1>
            <p class="text-sm text-slate-500">Nabilah Pulungan</p>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <a href="#" onclick="showView('dashboard')" class="nav-link active flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 bg-slate-100 transition-all duration-200">
                <div id="dashboard-icon-container"></div><span class="font-medium">Dashboard</span>
            </a>
            <a href="#" onclick="showView('form-entry')" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 hover:text-slate-800 transition-all duration-200">
                <div id="plus-circle-icon-container"></div><span class="font-medium">Catat Transaksi</span>
            </a>
            <a href="#" onclick="showView('reports')" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 hover:text-slate-800 transition-all duration-200">
                <div id="bar-chart-icon-container"></div><span class="font-medium">Laporan</span>
            </a>
            <a href="#" onclick="showView('settings')" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 hover:text-slate-800 transition-all duration-200">
                <div id="settings-icon-container"></div><span class="font-medium">Pengaturan</span>
            </a>
        </nav>
        <div class="p-4 border-t border-slate-200 text-center">
            <p class="text-xs text-slate-400">Â© 2024 Dibuat untuk Nabilah P.</p>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto p-8 bg-slate-50">
        
        <!-- Dashboard View -->
        <div id="dashboard" class="view active">
            <h2 class="text-3xl font-bold text-slate-800 mb-2">Selamat Datang, Nabilah!</h2>
            <p class="text-slate-500 mb-8">Berikut ringkasan aktivitas klinik hari ini.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Stat Cards -->
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm animate-card" style="animation-delay: 0.1s;">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-slate-500">Pendapatan Total</h3>
                        <div class="w-10 h-10 bg-green-100 text-green-600 rounded-lg flex items-center justify-center" id="dollar-sign-icon-container"></div>
                    </div>
                    <p id="total-revenue-today" class="text-3xl font-bold text-slate-800">Rp 0</p>
                </div>
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm animate-card" style="animation-delay: 0.2s;">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-slate-500">Pendapatan QRIS</h3>
                        <div class="w-10 h-10 bg-sky-100 text-sky-600 rounded-lg flex items-center justify-center" id="qr-code-icon-container"></div>
                    </div>
                    <p id="total-qris-today" class="text-3xl font-bold text-slate-800">Rp 0</p>
                </div>
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm animate-card" style="animation-delay: 0.3s;">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-slate-500">Pendapatan Transfer</h3>
                         <div class="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-lg flex items-center justify-center" id="landmark-icon-container"></div>
                    </div>
                    <p id="total-transfer-today" class="text-3xl font-bold text-slate-800">Rp 0</p>
                </div>
                 <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm animate-card" style="animation-delay: 0.4s;">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-slate-500">Pendapatan Tunai</h3>
                         <div class="w-10 h-10 bg-amber-100 text-amber-600 rounded-lg flex items-center justify-center" id="wallet-icon-container"></div>
                    </div>
                    <p id="total-cash-today" class="text-3xl font-bold text-slate-800">Rp 0</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                <div class="lg:col-span-3 bg-white p-6 rounded-xl border border-slate-200 shadow-sm animate-card" style="animation-delay: 0.5s;">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Grafik Pemasukan 7 Hari Terakhir</h3>
                    <div class="h-80">
                        <canvas id="weekly-revenue-chart"></canvas>
                    </div>
                </div>
                <div class="lg:col-span-2 bg-white p-6 rounded-xl border border-slate-200 shadow-sm animate-card" style="animation-delay: 0.6s;">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Sumber Pemasukan Hari Ini</h3>
                    <div class="h-80">
                        <canvas id="revenue-breakdown-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Entry View -->
        <div id="form-entry" class="view">
            <h2 class="text-3xl font-bold text-slate-800 mb-6">Pencatatan Baru</h2>
            <div class="bg-white p-8 rounded-xl border border-slate-200 shadow-sm max-w-4xl mx-auto">
                <form id="main-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="transaction-type" class="block text-sm font-medium text-slate-700 required-label mb-2">Jenis Pencatatan</label>
                            <select id="transaction-type" name="transaction-type" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                <option value="">-- Pilih Jenis --</option>
                                <option value="reservasi">Kunjungan / Reservasi</option>
                                <option value="produk">Penjualan Produk</option>
                                <option value="pengeluaran">Pengeluaran Uang</option>
                                <option value="pemasukan_lain">Pemasukan Lain</option>
                                <option value="administrasi">Administrasi Surat/Berkas</option>
                            </select>
                        </div>
                        <div>
                             <label for="transaction-date" class="block text-sm font-medium text-slate-700 required-label mb-2">Tanggal Transaksi</label>
                             <input type="date" id="transaction-date" name="transaction_date" required class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        </div>
                    </div>

                    <!-- Dynamic form sections will be injected here by JavaScript -->
                    <div id="dynamic-form-section" class="space-y-6 pt-6 border-t border-slate-200"></div>

                    <div class="flex justify-end gap-4 pt-6">
                        <button type="button" onclick="resetForm()" class="px-6 py-3 bg-slate-100 text-slate-700 font-semibold rounded-lg hover:bg-slate-200 transition-transform hover:scale-105">Batal</button>
                        <button type="submit" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-transform hover:scale-105 shadow-md hover:shadow-lg flex items-center gap-2">
                            <div id="save-icon-container"></div>
                            Simpan Data
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Reports View -->
        <div id="reports" class="view">
            <h2 class="text-3xl font-bold text-slate-800 mb-6">Laporan & Statistik</h2>
            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm mb-8">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">Filter Laporan</h3>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                     <div>
                         <label for="report-start-date" class="block text-sm font-medium text-slate-700 mb-1">Tanggal Mulai</label>
                         <input type="date" id="report-start-date" class="w-full p-2 border border-slate-300 rounded-lg">
                     </div>
                     <div>
                         <label for="report-end-date" class="block text-sm font-medium text-slate-700 mb-1">Tanggal Akhir</label>
                         <input type="date" id="report-end-date" class="w-full p-2 border border-slate-300 rounded-lg">
                     </div>
                     <button id="filter-button" class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-transform hover:scale-105">Terapkan Filter</button>
                 </div>
            </div>
            
            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                    <h3 class="text-lg font-semibold text-slate-800">Detail Semua Transaksi</h3>
                    <div class="flex items-center gap-2">
                        <button id="export-csv-button" class="export-btn flex items-center gap-2 text-sm px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-transform hover:scale-105"><div id="csv-icon-container"></div>CSV</button>
                        <button id="export-excel-button" class="export-btn flex items-center gap-2 text-sm px-4 py-2 bg-green-800 text-white rounded-lg hover:bg-green-900 transition-transform hover:scale-105"><div id="excel-icon-container"></div>Excel</button>
                        <button id="export-pdf-button" class="export-btn flex items-center gap-2 text-sm px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-transform hover:scale-105"><div id="pdf-icon-container"></div>PDF</button>
                        <button id="refresh-data-button" class="flex items-center gap-2 text-sm px-4 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 transition-transform hover:scale-105">
                            <div id="refresh-cw-icon-container"></div>
                        </button>
                    </div>
                </div>
                <div id="table-container" class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-500">
                        <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                            <tr>
                                <th scope="col" class="px-6 py-3">Tanggal</th>
                                <th scope="col" class="px-6 py-3">Jenis</th>
                                <th scope="col" class="px-6 py-3">Deskripsi</th>
                                <th scope="col" class="px-6 py-3">Metode Bayar</th>
                                <th scope="col" class="px-6 py-3 text-right">Nominal</th>
                            </tr>
                        </thead>
                        <tbody id="transaction-table-body">
                           <!-- Data will be loaded here -->
                           <tr><td colspan="5" class="text-center p-8 text-slate-400">
                                <div id="reports-loader-container">Memuat data...</div>
                           </td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Settings View -->
        <div id="settings" class="view">
            <h2 class="text-3xl font-bold text-slate-800 mb-6">Pengaturan Aplikasi</h2>
            <div class="bg-white p-8 rounded-xl border border-slate-200 shadow-sm max-w-4xl mx-auto">
                <h3 class="text-lg font-semibold text-slate-800 mb-2">Koneksi Google Sheets</h3>
                <p class="text-sm text-slate-500 mb-6">Aplikasi ini menyimpan semua data Anda dengan aman di Google Sheets pribadi Anda. Pastikan Anda menggunakan kode Apps Script terbaru di bawah ini.</p>

                <div class="mb-6">
                    <label for="google-script-url" class="block text-sm font-medium text-slate-700 required-label mb-2">URL Web App Google Apps Script</label>
                    <input type="url" id="google-script-url" placeholder="https://script.google.com/macros/s/..." class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
                <button onclick="saveSettings()" class="w-full px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-transform hover:scale-105">Simpan Pengaturan</button>

                <div class="mt-8 pt-6 border-t border-slate-200">
                    <h4 class="font-semibold text-slate-800 mb-3">Panduan & Kode Apps Script (Versi 2.1 - PENTING):</h4>
                    <textarea id="apps-script-code" readonly class="w-full h-48 mt-2 p-3 font-mono text-xs bg-slate-100 rounded-lg border border-slate-300 resize-none">
function doGet(e) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheetName = "Data";
  const sheet = ss.getSheetByNafunction doGet(e) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheetName = "Data";
    const sheet = ss.getSheetByName(sheetName) || ss.insertSheet(sheetName);
    
    const headers = ["Timestamp", "Date", "Type", "Details", "Amount", "PaymentMethod", "RawData"];
    
    // Set header jika sheet kosong
    if (sheet.getLastRow() === 0) {
      sheet.appendRow(headers);
      // Set format kolom Date
      sheet.getRange("B:B").setNumberFormat("yyyy-mm-dd");
    }

    // Jika hanya ada header, return array kosong
    if (sheet.getLastRow() < 2) {
      return ContentService.createTextOutput(JSON.stringify([]))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // Ambil data yang benar-benar berisi data
    const lastRow = sheet.getLastRow();
    const dataRange = sheet.getRange(2, 1, lastRow - 1, headers.length);
    const data = dataRange.getValues();
    
    // Konversi ke JSON dengan handling tanggal yang lebih robust
    const jsonData = data.map(row => {
      let obj = {};
      headers.forEach((header, i) => {
        if (header === "Date") {
          // Handle berbagai format tanggal
          if (row[i] instanceof Date) {
            obj[header] = Utilities.formatDate(row[i], "GMT+7", "yyyy-MM-dd");
          } else if (typeof row[i] === 'string' && row[i].match(/^\d{4}-\d{2}-\d{2}$/)) {
            obj[header] = row[i]; // Already in correct format
          } else if (row[i] && row[i] !== "") {
            // Try to parse other date formats
            try {
              const parsedDate = new Date(row[i]);
              if (!isNaN(parsedDate.getTime())) {
                obj[header] = Utilities.formatDate(parsedDate, "GMT+7", "yyyy-MM-dd");
              } else {
                obj[header] = "Invalid Date";
              }
            } catch (e) {
              obj[header] = row[i];
            }
          } else {
            obj[header] = row[i];
          }
        } else {
          obj[header] = row[i];
        }
      });
      return obj;
    });
    
    // Return data terbalik (terbaru pertama)
    return ContentService.createTextOutput(JSON.stringify(jsonData.reverse()))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    Logger.log("Error in doGet: " + error.toString());
    return ContentService.createTextOutput(JSON.stringify({ 
      status: "error", 
      message: error.toString() 
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function doPost(e) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheetName = "Data";
    const sheet = ss.getSheetByName(sheetName) || ss.insertSheet(sheetName);
    
    const headers = ["Timestamp", "Date", "Type", "Details", "Amount", "PaymentMethod", "RawData"];
    
    // Set header dan format jika sheet kosong
    if (sheet.getLastRow() === 0) {
      sheet.appendRow(headers);
      // Set format kolom
      sheet.getRange("A:A").setNumberFormat("yyyy-mm-dd hh:mm:ss");
      sheet.getRange("B:B").setNumberFormat("yyyy-mm-dd");
      sheet.getRange("E:E").setNumberFormat("#,##0");
    }

    // Parse incoming data
    let data;
    try {
      data = JSON.parse(e.postData.contents);
    } catch (parseError) {
      return ContentService.createTextOutput(JSON.stringify({ 
        status: "error", 
        message: "Invalid JSON format: " + parseError.toString() 
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    const timestamp = new Date();
    
    // Handle tanggal dengan lebih robust
    let transactionDate;
    if (data.transaction_date) {
      try {
        // Coba parse berbagai format tanggal
        if (typeof data.transaction_date === 'string') {
          if (data.transaction_date.match(/^\d{4}-\d{2}-\d{2}$/)) {
            // Format yyyy-mm-dd
            transactionDate = new Date(data.transaction_date + 'T00:00:00+07:00');
          } else {
            // Coba parse format lain
            transactionDate = new Date(data.transaction_date);
          }
        } else if (data.transaction_date instanceof Date) {
          transactionDate = data.transaction_date;
        }
        
        // Validasi tanggal
        if (isNaN(transactionDate.getTime())) {
          transactionDate = timestamp; // Fallback ke timestamp sekarang
        }
      } catch (dateError) {
        transactionDate = timestamp; // Fallback ke timestamp sekarang
      }
    } else {
      transactionDate = timestamp; // Fallback ke timestamp sekarang
    }
    
    const formattedDate = Utilities.formatDate(transactionDate, "GMT+7", "yyyy-MM-dd");
    const type = data.type || "N/A";
    
    // Build details based on transaction type
    let details = "";
    if (type === "Kunjungan / Reservasi") {
      details = `Layanan: ${data.service_type || "N/A"} - Pasien: ${data.customer_name || "N/A"}`;
      if (data.homecare_location) details += ` - Lokasi: ${data.homecare_location}`;
    } else if (type === "Penjualan Produk") {
      details = `Produk: ${data.product_name || "N/A"} - Qty: ${data.quantity || 0}`;
    } else {
      details = data.description || "N/A";
    }

    const amount = parseFloat(data.nominal) || 0;
    const paymentMethod = data.payment_method || "N/A";

    // Append data to sheet
    sheet.appendRow([
      timestamp, 
      formattedDate, 
      type, 
      details, 
      amount, 
      paymentMethod, 
      JSON.stringify(data)
    ]);
    
    return ContentService.createTextOutput(JSON.stringify({ 
      status: "success", 
      message: "Data saved successfully",
      saved_data: {
        timestamp: timestamp,
        date: formattedDate,
        type: type,
        details: details,
        amount: amount,
        payment_method: paymentMethod
      }
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    Logger.log("Error in doPost: " + error.toString());
    return ContentService.createTextOutput(JSON.stringify({ 
      status: "error", 
      message: error.toString() 
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// Helper function untuk testing
function testDoPost() {
  // Test data untuk kunjungan
  const testData = {
    transaction_date: "2024-01-15",
    type: "Kunjungan / Reservasi",
    service_type: "Pijat Relaksasi",
    customer_name: "Budi Santoso",
    homecare_location: "Jakarta Selatan",
    nominal: 150000,
    payment_method: "Transfer Bank"
  };
  
  const mockEvent = {
    postData: {
      contents: JSON.stringify(testData)
    }
  };
  
  const result = doPost(mockEvent);
  Logger.log(result.getContent());
}

function testDoGet() {
  const result = doGet({});
  Logger.log(result.getContent());
}me(sheetName) || ss.insertSheet(sheetName);
  
  const headers = ["Timestamp", "Date", "Type", "Details", "Amount", "PaymentMethod", "RawData"];
  
  if (sheet.getLastRow() === 0) {
    sheet.appendRow(headers);
  }

  if (sheet.getLastRow() < 2) { // If only headers exist or sheet is brand new
    return ContentService.createTextOutput(JSON.stringify([])).setMimeType(ContentService.MimeType.JSON);
  }
  
  // Get data from row 2 to the end to avoid performance issues with empty rows
  const dataRange = sheet.getRange(2, 1, sheet.getLastRow() - 1, headers.length);
  const data = dataRange.getValues();
  
  const jsonData = data.map(row => {
    let obj = {};
    headers.forEach((header, i) => {
      // **FIX:** This is the crucial fix for the date timezone problem.
      // It ensures the date is always a 'yyyy-MM-dd' string, matching what the app expects.
      if (header === "Date" && row[i] instanceof Date) {
        obj[header] = Utilities.formatDate(new Date(row[i]), "GMT+7", "yyyy-MM-dd");
      } else {
        obj[header] = row[i];
      }
    });
    return obj;
  });
  
  return ContentService.createTextOutput(JSON.stringify(jsonData.reverse())).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheetName = "Data";
    const sheet = ss.getSheetByName(sheetName) || ss.insertSheet(sheetName);
    
    const headers = ["Timestamp", "Date", "Type", "Details", "Amount", "PaymentMethod", "RawData"];
    
    if (sheet.getLastRow() === 0) {
      sheet.appendRow(headers);
    }

    const data = JSON.parse(e.postData.contents);
    
    const timestamp = new Date();
    // Use date from user input, fallback to today in GMT+7
    const date = data.transaction_date ? new Date(data.transaction_date) : timestamp;
    const formattedDate = Utilities.formatDate(date, "GMT+7", "yyyy-MM-dd");

    const type = data.type || "N/A";
    
    let details = "";
    if (type === "Kunjungan / Reservasi") {
      details = `Layanan: ${data.service_type} - Pasien: ${data.customer_name}`;
      if (data.homecare_location) details += ` - Lokasi: ${data.homecare_location}`;
    } else if (type === "Penjualan Produk") {
      details = `Produk: ${data.product_name} - Qty: ${data.quantity}`;
    } else {
      details = data.description || "N/A";
    }

    const amount = data.nominal || 0;
    const paymentMethod = data.payment_method || "N/A";

    sheet.appendRow([timestamp, formattedDate, type, details, amount, paymentMethod, JSON.stringify(data)]);
    
    return ContentService.createTextOutput(JSON.stringify({ status: "success", message: "Data saved successfully" })).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    Logger.log(error);
    return ContentService.createTextOutput(JSON.stringify({ status: "error", message: error.toString() })).setMimeType(ContentService.MimeType.JSON);
  }
}
                    </textarea>
                    <p class="text-xs text-slate-500 mt-2">Salin dan ganti semua kode di Apps Script Anda dengan kode di atas, lalu Deploy ulang. dapatkan kode/ link url web app nya</p>
                </div>
            </div>
        </div>

    </main>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-[120%] transition-all duration-500 ease-in-out">
        <p id="toast-message">Data berhasil disimpan!</p>
    </div>

    <script>
        // --- RENDER ICONS ---
        const iconElements = {
            'dashboard-icon-container': 'layout-dashboard', 'plus-circle-icon-container': 'plus-circle',
            'bar-chart-icon-container': 'bar-chart-3', 'settings-icon-container': 'settings',
            'dollar-sign-icon-container': 'dollar-sign', 'qr-code-icon-container': 'qr-code',
            'landmark-icon-container': 'landmark', 'wallet-icon-container': 'wallet',
            'save-icon-container': 'save', 'refresh-cw-icon-container': 'refresh-cw',
            'csv-icon-container': 'file-spreadsheet', 'excel-icon-container': 'file-sheet', 'pdf-icon-container': 'file-text'
        };
        
        function renderIcons() {
            if (typeof lucide === 'undefined') {
                console.error("Lucide icons not loaded yet.");
                return;
            }
            for (const containerId in iconElements) {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = '';
                    lucide.createIcons({
                        icons: [iconElements[containerId]],
                        attrs: { size: 18 }
                    });
                    // lucide.createIcons will auto-replace <i data-lucide="icon-name">, so we use it below:
                    container.innerHTML = `<i data-lucide="${iconElements[containerId]}"></i>`;
                    lucide.createIcons();
                }
            }
        }

        // --- APPLICATION STATE & CONFIG ---
        const GOOGLE_SCRIPT_URL_KEY = 'nabilahClinicApp_googleScriptUrl_v2';
        let googleScriptUrl = localStorage.getItem(GOOGLE_SCRIPT_URL_KEY);
        let weeklyRevenueChart, revenueBreakdownChart;
        let ALL_TRANSACTIONS = [];

        // --- UI & NAVIGATION ---
        const views = document.querySelectorAll('.view');
        const navLinks = document.querySelectorAll('.nav-link');
        const transactionDateInput = document.getElementById('transaction-date');

        function showView(viewId) {
            views.forEach(view => view.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            navLinks.forEach(link => {
                link.classList.remove('active', 'bg-slate-100');
                if (link.getAttribute('onclick').includes(viewId)) {
                    link.classList.add('active', 'bg-slate-100');
                }
            });

            if ((viewId === 'dashboard' || viewId === 'reports') && ALL_TRANSACTIONS.length === 0) {
                fetchAndDisplayData();
            } else if (viewId === 'dashboard' || viewId === 'reports') {
                processAndDisplayData(ALL_TRANSACTIONS);
            }
        }
        
        // --- DATE HELPER ---
        const toYYYYMMDD = (date) => date.toISOString().slice(0, 10);

        // --- FORM LOGIC ---
        const transactionTypeSelect = document.getElementById('transaction-type');
        const dynamicFormSection = document.getElementById('dynamic-form-section');
        const mainForm = document.getElementById('main-form');

        transactionTypeSelect.addEventListener('change', (e) => renderDynamicForm(e.target.value));

        function renderDynamicForm(type) {
            dynamicFormSection.innerHTML = '';
            let formHtml = '';

            const commonPaymentFields = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="nominal" class="block text-sm font-medium text-slate-700 required-label mb-2">Nominal Pembayaran</label>
                        <input type="number" id="nominal" name="nominal" required class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Contoh: 50000">
                    </div>
                    <div>
                        <label for="payment-method" class="block text-sm font-medium text-slate-700 required-label mb-2">Metode Pembayaran</label>
                        <select id="payment-method" name="payment_method" required class="w-full p-3 border border-slate-300 rounded-lg">
                            <option value="QRIS">QRIS</option>
                            <option value="Transfer">Transfer</option>
                            <option value="Cash">Tunai</option>
                        </select>
                    </div>
                </div>
            `;
            const descriptionField = (label, placeholder) => `
                <div>
                    <label for="description" class="block text-sm font-medium text-slate-700 required-label mb-2">${label}</label>
                    <textarea id="description" name="description" required rows="3" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="${placeholder}"></textarea>
                </div>
            `;
            const nominalField = (label, placeholder) => `
                <div>
                    <label for="nominal" class="block text-sm font-medium text-slate-700 required-label mb-2">${label}</label>
                    <input type="number" id="nominal" name="nominal" required class="w-full p-3 border border-slate-300 rounded-lg" placeholder="${placeholder}">
                </div>
            `;

            switch (type) {
                case 'reservasi':
                    formHtml = `
                        <div>
                            <label for="service-type" class="block text-sm font-medium text-slate-700 required-label mb-2">Jenis Layanan</label>
                            <select id="service-type" name="service_type" required class="w-full p-3 border border-slate-300 rounded-lg">
                                <option value="Baby/Kid Spa">Baby/Kid Spa</option> <option value="Mom/Ladies Spa">Mom/Ladies Spa</option>
                                <option value="Tindik dr Evoo">Tindik dr Evoo</option> <option value="Home Care">Home Care</option>
                                <option value="Senam/Yoga">Senam/Yoga</option>
                            </select>
                        </div>
                        <div id="homecare-section" class="hidden">
                             <label for="homecare-location" class="block text-sm font-medium text-slate-700 required-label mb-2">Alamat atau Lokasi Home Care</label>
                             <textarea id="homecare-location" name="homecare_location" rows="2" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Contoh: Perawatan Ibu Nani, Jl. Merdeka No. 10"></textarea>
                        </div>
                        <div>
                            <label for="customer-name" class="block text-sm font-medium text-slate-700 required-label mb-2">Nama Treatment/Layanan; Nama Pasien/Pelanggan; Terapis yang megang</label>
                            <input type="text" id="customer-name" name="customer_name" required class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Masukkan berurutan">
                        </div>
                        ${commonPaymentFields}
                    `;
                    break;
                case 'produk':
                    formHtml = `
                        <div>
                            <label for="product-name" class="block text-sm font-medium text-slate-700 required-label mb-2">Nama Produk / Minuman / Obat / Makanan / Herbal</label>
                            <input type="text" id="product-name" name="product_name" required class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Contoh: Minyak Telon">
                        </div>
                        <div>
                            <label for="quantity" class="block text-sm font-medium text-slate-700 required-label mb-2">Jumlah</label>
                            <input type="number" id="quantity" name="quantity" required value="1" class="w-full p-3 border border-slate-300 rounded-lg">
                        </div>
                        ${commonPaymentFields}
                    `;
                    break;
                case 'pengeluaran':
                    formHtml = `${descriptionField('Deskripsi Pengeluaran', 'Contoh: Beli galon air, bayar listrik')} ${nominalField('Nominal Pengeluaran', 'Contoh: 25000')}`;
                    break;
                case 'pemasukan_lain':
                    formHtml = `${descriptionField('Deskripsi Pemasukan', 'Contoh: Uang tip')} ${nominalField('Nominal Pemasukan', 'Contoh: 10000')}`;
                    break;
                case 'administrasi':
                     formHtml = `
                        <div>
                            <label for="description" class="block text-sm font-medium text-slate-700 required-label mb-2">Jenis Surat / Berkas / Nama Dokumen</label>
                            <input type="text" id="description" name="description" required class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Contoh: Surat keterangan lahir">
                        </div>
                        ${commonPaymentFields}
                    `;
                    break;
            }
            dynamicFormSection.innerHTML = formHtml;
            
            const serviceTypeSelect = document.getElementById('service-type');
            if(serviceTypeSelect){
                serviceTypeSelect.addEventListener('change', e => {
                    const homecareSection = document.getElementById('homecare-section');
                    const isHomeCare = e.target.value === 'Home Care';
                    homecareSection.classList.toggle('hidden', !isHomeCare);
                    homecareSection.querySelector('textarea').required = isHomeCare;
                });
            }
        }

        function resetForm() {
            mainForm.reset();
            transactionDateInput.value = toYYYYMMDD(new Date());
            dynamicFormSection.innerHTML = '';
        }
        
        // --- DATA HANDLING (GOOGLE SHEETS) ---
        mainForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!googleScriptUrl) {
                showToast('URL Google Script belum diatur. Cek menu Pengaturan.', 'error');
                return;
            }

            const formData = new FormData(mainForm);
            const data = Object.fromEntries(formData.entries());
            
            const typeMap = {
                'reservasi': 'Kunjungan / Reservasi', 'produk': 'Penjualan Produk',
                'pengeluaran': 'Pengeluaran', 'pemasukan_lain': 'Pemasukan Lain',
                'administrasi': 'Administrasi Surat'
            };
            data.type = typeMap[data['transaction-type']];
            
            if (data.type === 'Pengeluaran') {
                data.nominal = -Math.abs(data.nominal);
            }

            const submitButton = mainForm.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = 'Menyimpan...';
            
            try {
                const response = await fetch(googleScriptUrl, {
                    method: 'POST', redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    showToast('Data berhasil disimpan!');
                    resetForm();
                    fetchAndDisplayData(true); // Force refresh
                } else { throw new Error(result.message); }
            } catch (error) {
                console.error('Error saving data:', error);
                showToast(`Gagal menyimpan: ${error.message}`, 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = `<div id="save-icon-container"></div> Simpan Data`;
                ReactDOM.render(React.createElement(lucide['Save'], { size: 18 }), submitButton.querySelector('#save-icon-container'));
            }
        });

        async function fetchDataFromGoogleSheet() {
            if (!googleScriptUrl) return null;
            try {
                const response = await fetch(googleScriptUrl);
                if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                return await response.json();
            } catch (error) {
                console.error("Failed to fetch data:", error);
                showToast("Gagal memuat data dari Google Sheets.", 'error');
                return null;
            }
        }
        
        function showLoader(containerId) {
            const container = document.getElementById(containerId);
            if(container) container.innerHTML = `<div class="loader"></div>`;
        }
        
        function hideLoader(containerId, defaultMessage) {
            const container = document.getElementById(containerId);
            if(container) container.innerHTML = defaultMessage;
        }

        // --- DASHBOARD & REPORTS ---
        async function fetchAndDisplayData(forceRefresh = false) {
            if (forceRefresh) ALL_TRANSACTIONS = [];
            showLoader('reports-loader-container');
            const data = await fetchDataFromGoogleSheet();
            if (data) {
                ALL_TRANSACTIONS = data;
                processAndDisplayData(ALL_TRANSACTIONS);
            } else {
                hideLoader('reports-loader-container', `<tr><td colspan="5" class="text-center p-8 text-slate-400">Gagal memuat data. Periksa Pengaturan.</td></tr>`);
                document.getElementById('transaction-table-body').innerHTML = `<tr><td colspan="5" class="text-center p-8 text-slate-400">Gagal memuat data. Periksa Pengaturan.</td></tr>`;
            }
        }

        function processAndDisplayData(data) {
            updateDashboard(data);
            updateReportsTable(data);
            updateCharts(data);
        }

        function formatCurrency(amount) {
            return `Rp ${parseInt(amount).toLocaleString('id-ID')}`;
        }

        function updateDashboard(data) {
            // GUNAKAN SEMUA DATA (total keseluruhan)
            const allData = data;
    
            const calculateTotal = (filterFn) => allData.filter(filterFn).reduce((sum, row) => sum + (parseFloat(row.Amount) || 0), 0);
    
            // Hitung total revenue (pemasukan - pengeluaran)
            const revenueTotal = calculateTotal(row => parseFloat(row.Amount) > 0);
            const expenseTotal = calculateTotal(row => parseFloat(row.Amount) < 0);
            const netRevenue = revenueTotal - Math.abs(expenseTotal);
    
            const qrisTotal = calculateTotal(row => row.PaymentMethod === 'QRIS' && parseFloat(row.Amount) > 0);
            const transferTotal = calculateTotal(row => row.PaymentMethod === 'Transfer' && parseFloat(row.Amount) > 0);
            const cashTotal = calculateTotal(row => row.PaymentMethod === 'Cash' && parseFloat(row.Amount) > 0);
    
            // Update tampilan
            document.getElementById('total-revenue-today').textContent = formatCurrency(netRevenue);
            document.getElementById('total-qris-today').textContent = formatCurrency(qrisTotal);
            document.getElementById('total-transfer-today').textContent = formatCurrency(transferTotal);
            document.getElementById('total-cash-today').textContent = formatCurrency(cashTotal);
    
            // OPTIONAL: Update judul dashboard untuk kejelasan
            document.querySelector('#dashboard h2').textContent = "Selamat Datang, Nabilah!";
            document.querySelector('#dashboard p').textContent = "Berikut ringkasan aktivitas klinik secara keseluruhan.";
        }

        function updateReportsTable(data, startDate, endDate) {
             const tableBody = document.getElementById('transaction-table-body');
             tableBody.innerHTML = '';

             let filteredData = data;
             if (startDate && endDate) {
                filteredData = data.filter(row => {
                    const rowDate = row.Date; 
                    return rowDate >= startDate && rowDate <= endDate;
                });
             }
             
             if(filteredData.length === 0){
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-slate-400">Tidak ada data untuk rentang tanggal yang dipilih.</td></tr>`;
                return;
             }

             filteredData.forEach(row => {
                 const { Date: date, Type: type, Details: details, Amount: amount, PaymentMethod: paymentMethod } = row;
                 const isExpense = parseFloat(amount) < 0;
                 const amountColor = isExpense ? 'text-red-600' : 'text-green-600';
                 const amountPrefix = !isExpense && parseFloat(amount) > 0 ? '+' : '';

                 // **FIX:** Gracefully handle potential invalid date strings from the sheet.
                 let displayDate = 'Data Tanggal Salah';
                 if (date && typeof date === 'string' && date.includes('-')) {
                     // Parsing 'YYYY-MM-DD' can be tricky. Appending time makes it more stable across browsers.
                     // Using T12:00:00 avoids timezone shifts that could change the day.
                     const dateObj = new Date(date + 'T12:00:00');
                     // Check if the resulting date object is valid.
                     if (!isNaN(dateObj.getTime())) {
                         displayDate = dateObj.toLocaleDateString('id-ID', {day:'2-digit', month:'short', year:'numeric'});
                     }
                 }

                 const tr = document.createElement('tr');
                 tr.className = 'bg-white border-b hover:bg-slate-50 transition-colors';
                 tr.innerHTML = `
                    <td class="px-6 py-4">${displayDate}</td>
                    <td class="px-6 py-4 font-medium text-slate-800">${type}</td>
                    <td class="px-6 py-4 max-w-sm truncate" title="${details}">${details}</td>
                    <td class="px-6 py-4">${paymentMethod || 'N/A'}</td>
                    <td class="px-6 py-4 text-right font-semibold ${amountColor}">${amountPrefix} ${formatCurrency(amount)}</td>
                 `;
                 tableBody.appendChild(tr);
             });
        }
        
        document.getElementById('filter-button').addEventListener('click', () => {
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            if(!startDate || !endDate){
                showToast('Harap pilih tanggal mulai dan tanggal akhir', 'error');
                return;
            }
            updateReportsTable(ALL_TRANSACTIONS, startDate, endDate);
        });

        document.getElementById('refresh-data-button').addEventListener('click', () => fetchAndDisplayData(true));

        function updateCharts(data) {
            // --- Weekly Revenue Chart (Dashboard) ---
            const weeklyCtx = document.getElementById('weekly-revenue-chart').getContext('2d');
            const weeklyLabels = [];
            const weeklyData = [];
            
            for(let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateString = toYYYYMMDD(d);
                weeklyLabels.push(d.toLocaleDateString('id-ID', { weekday: 'short' }));
                
                const revenueForDay = data
                    .filter(row => row.Date === dateString && parseFloat(row.Amount) > 0)
                    .reduce((sum, row) => sum + (parseFloat(row.Amount) || 0), 0);
                weeklyData.push(revenueForDay);
            }

            if (weeklyRevenueChart) weeklyRevenueChart.destroy();
            weeklyRevenueChart = new Chart(weeklyCtx, {
                type: 'bar',
                data: {
                    labels: weeklyLabels,
                    datasets: [{
                        label: 'Pendapatan', data: weeklyData,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)', borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1, borderRadius: 5,
                    }]
                },
                options: {
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } },
                    responsive: true, maintainAspectRatio: false,
                }
            });

            // --- Revenue Breakdown Chart (Dashboard) ---
            const breakdownCtx = document.getElementById('revenue-breakdown-chart').getContext('2d');
            const today = toYYYYMMDD(new Date());
            const todaysData = data.filter(row => row.Date === today);
            const breakdownData = {};
            todaysData.forEach(row => {
                if (parseFloat(row.Amount) > 0) {
                    breakdownData[row.Type] = (breakdownData[row.Type] || 0) + parseFloat(row.Amount);
                }
            });

            if (revenueBreakdownChart) revenueBreakdownChart.destroy();
            revenueBreakdownChart = new Chart(breakdownCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(breakdownData),
                    datasets: [{
                        label: 'Sumber Pendapatan',
                        data: Object.values(breakdownData),
                        backgroundColor: ['rgba(59, 130, 246, 0.8)', 'rgba(16, 185, 129, 0.8)', 'rgba(249, 115, 22, 0.8)', 'rgba(139, 92, 246, 0.8)'],
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { padding: 15 } } }
                }
            });
        }
        
        // --- DATA EXPORTING ---
        function getFilteredDataForExport() {
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            if (startDate && endDate) {
                 return ALL_TRANSACTIONS.filter(row => {
                    const rowDate = row.Date;
                    return rowDate >= startDate && rowDate <= endDate;
                });
            }
            return ALL_TRANSACTIONS;
        }

        document.getElementById('export-csv-button').addEventListener('click', () => {
            const data = getFilteredDataForExport();
            if (data.length === 0) { showToast('Tidak ada data untuk diekspor', 'error'); return; }
            const headers = "Tanggal,Jenis,Deskripsi,Metode Pembayaran,Nominal\n";
            const csvContent = data.map(row => 
                `"${row.Date}","${row.Type}","${row.Details.replace(/"/g, '""')}","${row.PaymentMethod}",${row.Amount}`
            ).join("\n");

            const blob = new Blob([headers + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Laporan_Keuangan_${toYYYYMMDD(new Date())}.csv`;
            link.click();
            URL.revokeObjectURL(link.href);
        });

        document.getElementById('export-excel-button').addEventListener('click', () => {
            const data = getFilteredDataForExport();
            if (data.length === 0) { showToast('Tidak ada data untuk diekspor', 'error'); return; }

            const worksheetData = data.map(row => ({
                'Tanggal': row.Date, 'Jenis': row.Type, 'Deskripsi': row.Details,
                'Metode Pembayaran': row.PaymentMethod, 'Nominal': parseFloat(row.Amount)
            }));

            const worksheet = XLSX.utils.json_to_sheet(worksheetData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Laporan");
            XLSX.writeFile(workbook, `Laporan_Keuangan_${toYYYYMMDD(new Date())}.xlsx`);
        });

        document.getElementById('export-pdf-button').addEventListener('click', () => {
            const data = getFilteredDataForExport();
            if (data.length === 0) { showToast('Tidak ada data untuk diekspor', 'error'); return; }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.text("Laporan Keuangan", 14, 16);
            doc.setFontSize(10);
            doc.text(`Periode: ${document.getElementById('report-start-date').value} - ${document.getElementById('report-end-date').value}`, 14, 22);

            doc.autoTable({
                startY: 28,
                head: [['Tanggal', 'Jenis', 'Deskripsi', 'Metode Bayar', 'Nominal']],
                body: data.map(row => [
                    row.Date, row.Type, row.Details, row.PaymentMethod, formatCurrency(row.Amount)
                ]),
                headStyles: { fillColor: [59, 130, 246] },
                styles: { fontSize: 8 },
                columnStyles: { 4: { halign: 'right' } }
            });

            doc.save(`Laporan_Keuangan_${toYYYYMMDD(new Date())}.pdf`);
        });


        // --- SETTINGS ---
        function saveSettings() {
            const url = document.getElementById('google-script-url').value;
            if (url && url.startsWith('https://script.google.com/macros/s/')) {
                localStorage.setItem(GOOGLE_SCRIPT_URL_KEY, url);
                googleScriptUrl = url;
                showToast('Pengaturan berhasil disimpan!');
                ALL_TRANSACTIONS = []; // Clear cache on settings change
                fetchAndDisplayData();
            } else {
                showToast('URL yang Anda masukkan tidak valid.', 'error');
            }
        }
        
        function loadSettings() {
            const url = localStorage.getItem(GOOGLE_SCRIPT_URL_KEY);
            if(url) document.getElementById('google-script-url').value = url;
        }
        
        // --- TOAST NOTIFICATION ---
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.querySelector('#toast-message').textContent = message;
            toast.className = 'fixed top-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-500 ease-in-out'; // reset
            toast.classList.add(type === 'error' ? 'bg-red-500' : 'bg-green-600');
            toast.classList.remove('translate-x-[120%]');
            setTimeout(() => toast.classList.add('translate-x-[120%]'), 3000);
        }

        // --- INITIALIZATION ---
        window.onload = () => {
            if (typeof lucide === 'undefined') {
                console.error("Lucide icons failed to load. Please check your internet connection and refresh.");
                document.body.innerHTML = `<div class="w-screen h-screen flex flex-col items-center justify-center text-center text-slate-600 p-8">
                    <h1 class="text-2xl font-bold">Oops! Gagal Memuat Komponen Aplikasi</h1>
                    <p class="mt-2">Sepertinya ada masalah saat memuat library penting. Coba periksa koneksi internet Anda dan muat ulang halaman.</p>
                </div>`;
                return;
            }
            renderIcons();
            loadSettings();
            
            const today = new Date();
            transactionDateInput.value = toYYYYMMDD(today);
            document.getElementById('report-end-date').value = toYYYYMMDD(today);
            today.setDate(today.getDate() - 30);
            document.getElementById('report-start-date').value = toYYYYMMDD(today);

            showView('dashboard');
        };
    </script>
</body>
</html>

